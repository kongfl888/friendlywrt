From ec15cd70d9f5fc82e6c10673e34e49f4bd151c71 Mon Sep 17 00:00:00 2001
From: Lawrence-Tang <tangzongsheng@gmail.com>
Date: Sat, 14 Dec 2019 15:52:26 +0800
Subject: [PATCH 09/55] add a script to enable swap

---
 package/base-files/files/etc/enable-swap.sh | 51 +++++++++++++++++++++++++++++
 1 file changed, 51 insertions(+)
 create mode 100755 package/base-files/files/etc/enable-swap.sh

diff --git a/package/base-files/files/etc/enable-swap.sh b/package/base-files/files/etc/enable-swap.sh
new file mode 100755
index 0000000000..e7bc6dee8d
--- /dev/null
+++ b/package/base-files/files/etc/enable-swap.sh
@@ -0,0 +1,51 @@
+#!/bin/bash
+
+enable_swap() {
+    if [ -e /swapfile ]; then
+        rm -f /swapfile
+    fi
+
+    DFRESULT=`df / | awk '$3 ~ /[0-9]+/ { print $4 }'`
+    SWAPSIZE=1048576
+    if [ $DFRESULT -gt 2500000 ]; then
+        # 2G
+        SWAPSIZE=2097152
+    elif [ $DFRESULT -gt 2000000 ]; then
+	# 1.5G
+	SWAPSIZE=1572864
+    elif [ $DFRESULT -gt 1500000 ]; then
+        # 1G
+	SWAPSIZE=1048576
+    elif [ $DFRESULT -gt 800000 ]; then
+	# 512M
+        SWAPSIZE=524288
+    else
+        echo "Fail to enable swap: No space left on device (${DFRESULT})"
+        exit 0
+    fi
+    
+    dd if=/dev/zero of=/swapfile bs=1024 count=$SWAPSIZE
+    chmod 600 /swapfile
+    mkswap /swapfile
+    swapon /swapfile
+
+    sed -i '/^vm.swappiness=.*/d' /etc/sysctl.conf
+    echo "vm.swappiness=10" >> /etc/sysctl.conf
+    sysctl -p
+
+    while uci -q delete fstab.@swap[-1]; do :; done
+    uci add fstab swap
+    uci set fstab.@swap[-1].enabled='1'
+    uci set fstab.@swap[-1].device='/swapfile'
+    uci set fstab.@swap[-1].label='foo'
+    uci commit fstab
+    echo "done"
+}
+
+HASSWAP=`swapon -s`
+if [ "x$HASSWAP" = "x" ]; then
+    enable_swap
+else
+    echo "swap has been enabled."
+fi
+
-- 
2.14.1.windows.1

