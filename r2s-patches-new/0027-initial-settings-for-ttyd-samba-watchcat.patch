From 1c36c36c26091385838b21d4e2b5028e4d5bb4d6 Mon Sep 17 00:00:00 2001
From: Lawrence-Tang <tangzongsheng@gmail.com>
Date: Tue, 14 Apr 2020 14:01:46 +0800
Subject: [PATCH 27/39] initial settings for ttyd, samba, watchcat

---
 package/base-files/files/root/setup.sh | 72 ++++++++++++++++----------
 1 file changed, 45 insertions(+), 27 deletions(-)

diff --git a/package/base-files/files/root/setup.sh b/package/base-files/files/root/setup.sh
index 9fed0c7ee2..8aed2c49f5 100644
--- a/package/base-files/files/root/setup.sh
+++ b/package/base-files/files/root/setup.sh
@@ -1,5 +1,4 @@
 #!/bin/sh
-
 # THIS SCIPRT ONLY RUN ONCE. Base on /etc/firstboot_${board}
 
 NEED_RESTART_SERVICE=0
@@ -7,7 +6,6 @@ NEED_RESTART_SERVICE=0
 setup_ssid()
 {
     local r=$1
-    local chip
 
     if ! uci show wireless.${r} >/dev/null 2>&1; then
         return
@@ -23,35 +21,20 @@ setup_ssid()
     if [ -e "${dev_path}/../idVendor" -a -e "${dev_path}/../idProduct" ]; then
 	    idVendor=`cat ${dev_path}/../idVendor`
 	    idProduct=`cat ${dev_path}/../idProduct`
-	    if [ "x${idVendor}:${idProduct}" = "x0bda:c811" ]; then
-		    chip="rtl8821cu"
-		    touch ${FE_DIR}/first_insert_${chip}     # for /etc/hotplug.d/usb/31-usb_wifi
-	    fi
-    fi
 
-    if [ -e "${dev_path}/vendor" -a -e "${dev_path}/device" ]; then
-	    idVendor=`cat ${dev_path}/vendor`
-	    idProduct=`cat ${dev_path}/device`
-
-	    # enable 5g wifi-ap (t4)
-	    if [ "x${idVendor}:${idProduct}" = "x0x02d0:0x4356" ]; then
-		    uci set wireless.${r}.hwmode='11a'
-		    uci set wireless.${r}.channel='153'
-	    fi
-
-	    # r2
-            if [ "x${idVendor}:${idProduct}" = "x0x02d0:0xa9bf" ]; then
-                    uci set wireless.${r}.hwmode='11a'
-                    uci set wireless.${r}.channel='153'
-            fi
+        # onboard wifi
+        # t4: 0x02d0:0x4356
+        # r2: 0x02d0:0xa9bf
+        if [ "x${idVendor}:${idProduct}" = "x0x02d0:0x4356" ] \
+                || [ "x${idVendor}:${idProduct}" = "x0x02d0:0xa9bf" ]; then
+                uci set wireless.${r}.hwmode='11a'
+                uci set wireless.${r}.channel='153'
+                uci set wireless.${r}.country = '00'
+        fi
     fi
 
     uci set wireless.${r}.disabled=0
-    if [ -n "${chip}" ];then
-        uci set wireless.default_${r}.ssid=${chip}-${mac}
-    else
-        uci set wireless.default_${r}.ssid=FriendlyWrt-${mac}
-    fi
+    uci set wireless.default_${r}.ssid=FriendlyWrt-${mac}
     uci set wireless.default_${r}.encryption=psk2
     uci set wireless.default_${r}.key=password
     uci commit
@@ -120,4 +103,39 @@ fi
 # fix netdata issue
 [ -d /usr/share/netdata/web ] && chown -R root:root /usr/share/netdata/web
 
+# Warning:
+#     Turning on this option will reduce security
+#     To turn it off, set to 0
+ENABLE_SIMPLIFIED_SETTINGS=1
+if [ ${ENABLE_SIMPLIFIED_SETTINGS} -eq 1 ]; then
+    # ttyd: accessible by lan and wan
+    [ -f /etc/init.d/ttyd ] && uci delete ttyd.@ttyd[0].interface
+
+    # samba
+    if [ -f /etc/samba/smb.conf.template ]; then
+        uci set samba.@samba[0].name='FriendlyWrt'
+        uci set samba.@samba[0].workgroup='WORKGROUP'
+        uci set samba.@samba[0].description='FriendlyWrt'
+        uci set samba.@samba[0].homes='1'
+        # samba: allow root access
+        sed -i -e "/\sinvalid users\s/s/^/#/" /etc/samba/smb.conf.template
+        # samba: accessible by lan and wan
+        sed -i -e "/\sinterfaces\s/s/^/#/" /etc/samba/smb.conf.template
+        # samba: set default password to 'password'
+        echo "root:0:XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX:8846F7EAEE8FB117AD06BDD830B7586C:[U          ]:LCT-00000001:" > /etc/samba/smbpasswd
+        sed -i '1 i ' /etc/samba/smb.conf.template
+        sed -i '1 i #   you can run "smbpasswd -a root" command to change password' /etc/samba/smb.conf.template
+        sed -i '1 i #   The default samba credentials: username: root, password: password' /etc/samba/smb.conf.template
+        sed -i '1 i # Important note:' /etc/samba/smb.conf.template
+    fi
+
+    # remove watchcat setting
+    [ -f /etc/init.d/watchcat ] && uci delete system.@watchcat[0]
+
+    uci commit
+    [ -f /etc/init.d/ttyd ] && /etc/init.d/ttyd restart
+    [ -f /etc/init.d/watchcat ] && /etc/init.d/watchcat stop
+    [ -f /etc/init.d/samba ] && /etc/init.d/samba restart
+fi
+
 logger "done"
-- 
2.28.0.windows.1

