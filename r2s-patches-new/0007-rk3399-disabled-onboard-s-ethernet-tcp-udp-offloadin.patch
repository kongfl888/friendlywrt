From b7dc14049a13e58ca72acd2eb0ba63e9f05b29fe Mon Sep 17 00:00:00 2001
From: Lawrence-Tang <tangzongsheng@gmail.com>
Date: Thu, 12 Dec 2019 16:01:45 +0800
Subject: [PATCH 07/55] rk3399: disabled onboard's ethernet tcp/udp offloading

---
 .../iface/12-disable-rk3399-eth-offloading         | 22 ++++++++++++++++++++++
 1 file changed, 22 insertions(+)
 create mode 100644 target/linux/rockchip-rk3399/base-files/etc/hotplug.d/iface/12-disable-rk3399-eth-offloading

diff --git a/target/linux/rockchip-rk3399/base-files/etc/hotplug.d/iface/12-disable-rk3399-eth-offloading b/target/linux/rockchip-rk3399/base-files/etc/hotplug.d/iface/12-disable-rk3399-eth-offloading
new file mode 100644
index 0000000000..ae462b1010
--- /dev/null
+++ b/target/linux/rockchip-rk3399/base-files/etc/hotplug.d/iface/12-disable-rk3399-eth-offloading
@@ -0,0 +1,22 @@
+#!/bin/sh
+
+. /lib/functions.sh
+. /lib/functions/network.sh
+
+[ -n "$INTERFACE" ] || exit 3
+[ "$INTERFACE" == "wan" ] || exit 4
+[ "$ACTION" == "ifup" ] || exit 1
+
+BOARD=$(cat /tmp/sysinfo/board_name | cut -d , -f2)
+logger -t disable-offloading "board = $BOARD"
+[ "$BOARD" == "nanopi-m4" -o "$BOARD" == "nanopc-t4" -o "$BOARD" == "nanopi-neo4" -o "$BOARD" == "som-rk3399" ] || exit 2
+logger -t disable-offloading "rk3399 board detected"
+
+ETHTOOL=/usr/sbin/ethtool
+[ -f $ETHTOOL ] || exit 5
+
+[ -d /sys/devices/platform/fe300000.ethernet/net/eth0 ] || exit 6
+$ETHTOOL -K eth0 rx off tx off
+
+logger -t disable-offloading "disabed rk3399 ethernet tcp/udp offloading tx/rx"
+exit 0
-- 
2.14.1.windows.1

