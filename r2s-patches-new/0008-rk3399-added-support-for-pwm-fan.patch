From fd2925a8ea93ce9a7a9401ec26aa2bcd7f805ffa Mon Sep 17 00:00:00 2001
From: Lawrence-Tang <tangzongsheng@gmail.com>
Date: Fri, 13 Dec 2019 17:53:13 +0800
Subject: [PATCH 08/53] rk3399: added support for pwm fan

---
 .../base-files/etc/init.d/fa-rk3399-pwmfan         |  9 ++++
 .../base-files/etc/rc.d/S96fa-rk3399-pwmfan        |  1 +
 .../base-files/usr/bin/start-rk3399-pwm-fan.sh     | 59 ++++++++++++++++++++++
 3 files changed, 69 insertions(+)
 create mode 100755 target/linux/rockchip-rk3399/base-files/etc/init.d/fa-rk3399-pwmfan
 create mode 120000 target/linux/rockchip-rk3399/base-files/etc/rc.d/S96fa-rk3399-pwmfan
 create mode 100755 target/linux/rockchip-rk3399/base-files/usr/bin/start-rk3399-pwm-fan.sh

diff --git a/target/linux/rockchip-rk3399/base-files/etc/init.d/fa-rk3399-pwmfan b/target/linux/rockchip-rk3399/base-files/etc/init.d/fa-rk3399-pwmfan
new file mode 100755
index 0000000000..84c019d18f
--- /dev/null
+++ b/target/linux/rockchip-rk3399/base-files/etc/init.d/fa-rk3399-pwmfan
@@ -0,0 +1,9 @@
+#!/bin/sh /etc/rc.common
+
+START=96
+ 
+start() {
+	echo "fa-pwmfan started"
+	/usr/bin/start-rk3399-pwm-fan.sh > /dev/null&
+}
+
diff --git a/target/linux/rockchip-rk3399/base-files/etc/rc.d/S96fa-rk3399-pwmfan b/target/linux/rockchip-rk3399/base-files/etc/rc.d/S96fa-rk3399-pwmfan
new file mode 120000
index 0000000000..bf6476254c
--- /dev/null
+++ b/target/linux/rockchip-rk3399/base-files/etc/rc.d/S96fa-rk3399-pwmfan
@@ -0,0 +1 @@
+../init.d/fa-rk3399-pwmfan
\ No newline at end of file
diff --git a/target/linux/rockchip-rk3399/base-files/usr/bin/start-rk3399-pwm-fan.sh b/target/linux/rockchip-rk3399/base-files/usr/bin/start-rk3399-pwm-fan.sh
new file mode 100755
index 0000000000..311b4c15da
--- /dev/null
+++ b/target/linux/rockchip-rk3399/base-files/usr/bin/start-rk3399-pwm-fan.sh
@@ -0,0 +1,59 @@
+#!/bin/bash
+
+if [ ! -d /sys/class/pwm/pwmchip1/pwm0 ]; then
+    echo 0 > /sys/class/pwm/pwmchip1/export
+fi
+sleep 1
+while [ ! -d /sys/class/pwm/pwmchip1/pwm0 ];
+do
+    sleep 1
+done
+ISENABLE=`cat /sys/class/pwm/pwmchip1/pwm0/enable`
+if [ $ISENABLE -eq 1 ]; then
+    echo 0 > /sys/class/pwm/pwmchip1/pwm0/enable
+fi
+echo 50000 > /sys/class/pwm/pwmchip1/pwm0/period
+echo 1 > /sys/class/pwm/pwmchip1/pwm0/enable
+
+# max speed run 5s
+echo 46990 > /sys/class/pwm/pwmchip1/pwm0/duty_cycle
+sleep 5
+echo 25000 > /sys/class/pwm/pwmchip1/pwm0/duty_cycle
+
+# declare -a CpuTemps=(55000 43000 38000 32000)
+# declare -a PwmDutyCycles=(1000 20000 30000 45000)
+
+declare -a CpuTemps=(75000 63000 58000 52000)
+declare -a PwmDutyCycles=(25000 35000 45000 46990)
+
+declare -a Percents=(100 75 50 25)
+DefaultDuty=49990
+DefaultPercents=0
+
+while true
+do
+	temp=$(cat /sys/class/thermal/thermal_zone0/temp)
+	INDEX=0
+	FOUNDTEMP=0
+	DUTY=$DefaultDuty
+	PERCENT=$DefaultPercents
+	
+	for i in 0 1 2 3; do
+		if [ $temp -gt ${CpuTemps[$i]} ]; then
+			INDEX=$i
+			FOUNDTEMP=1
+			break
+		fi	
+	done
+	if [ ${FOUNDTEMP} == 1 ]; then
+		DUTY=${PwmDutyCycles[$i]}
+		PERCENT=${Percents[$i]}
+	fi
+
+	echo $DUTY > /sys/class/pwm/pwmchip1/pwm0/duty_cycle;
+
+        # echo "temp: $temp, duty: $DUTY, ${PERCENT}%"
+        # cat /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_cur_freq
+
+	sleep 2s;
+done
-- 
2.14.1.windows.1

